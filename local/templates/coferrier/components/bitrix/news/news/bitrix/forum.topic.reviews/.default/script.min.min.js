(function(i){BX.namespace("BX.Forum");var h=function(a){this.id="FTRList"+a.form.id;this.mess={};this.form=a.form;if(!!a.id){for(var b=0;b<a.id.length;b++){this.bind(a.id[b])}}this.params={preorder:(a.preorder=="Y"),pageNumber:a.pageNumber,pageCount:a.pageCount};BX.addCustomEvent(this.form,"onAdd",BX.delegate(this.add,this));BX.addCustomEvent(this.form,"onRequest",BX.delegate(function(){if(typeof this.params.pageNumber!="undefined"){var c=this.form.elements.pageNumber;if(!c){c=BX.create("input",{props:{type:"hidden",name:"pageNumber"}});this.form.appendChild(c)}c.value=this.params.pageNumber}if(typeof this.params.pageCount!="undefined"){var d=BX.findChild(this.form,{attr:{name:"pageCount"}});if(!d){d=BX.create("input",{props:{type:"hidden",name:"pageCount"}});this.form.appendChild(d)}d.value=this.params.pageCount}},this));BX.addCustomEvent(this.form,"onResponse",BX.delegate(function(){var c=BX.findChild(this.form,{attr:{name:"pageNumber"}},true);if(c){BX.remove(c)}},this))};h.prototype={add:function(w,a){var x=BX(this.form.id+"container"),s,e={className:/reviews-reply-form|reviews-collapse/},y=i.fTextToNode(a.message);if(!x){x=BX.create("div",{attrs:{id:this.form.id+"container"},props:{className:"reviews-block-container reviews-reviews-block-container"},children:[BX.create("div",{props:{className:"reviews-block-outer"},children:[BX.create("div",{props:{className:"reviews-block-inner"}})]})]});i.fReplaceOrInsertNode(x,null,BX.findChild(document,e,true).parentNode,e);x=BX(this.form.id+"container")}s=(x?BX.findChild(x,{className:"reviews-block-inner"},true):null);if(y&&s){if(!!a.allMessages){i.fReplaceOrInsertNode(y,s,BX.findChild(document,e,true).parentNode,e);if(!!a.navigation&&!!a.pageNumber){var v=i.fTextToNode(a.navigation),u,t=(v?BX.findChildren(x.parentNode,{className:"reviews-navigation-box"},true):null);if(v){if(!t){x.parentNode.insertBefore(BX.create("div",{props:{className:"reviews-navigation-box reviews-navigation-top"}}),x);var b=x;do{b=b.nextSibling}while(b&&b.nodeType!=1);var c=BX.create("div",{props:{className:"reviews-navigation-box reviews-navigation-bottom"}});if(b){x.parentNode.insertBefore(c,b)}else{x.parentNode.appendChild(c)}t=BX.findChildren(x.parentNode,{className:"reviews-navigation-box"},true)}for(u=0;u<t.length;u++){t[u].innerHTML=v.innerHTML}}this.params.pageNumber=a.pageNumber;this.params.pageCount=a.pageCount}if(a.messagesID&&typeof a.messagesID=="object"){for(var d=0;d<a.messagesID.length;d++){if(a.messagesID[d]!=w){this.bind(a.messagesID[d])}}}}else{if(typeof a.message!="undefined"){if(this.params.preorder){s.appendChild(y)}else{s.insertBefore(y,s.firstChild)}}}i.fRunScripts(a.message);this.bind(w)}},bind:function(a){var b=BX("message"+a);if(!!b){this.mess["m"+a]={node:b,author:{id:b.getAttribute("bx-author-id"),name:b.getAttribute("bx-author-name")}};var c=BX.findChildren(b,{tagName:"A",className:"reviews-button-small"},true),d=BX.delegate(function(){var k=BX.proxy_context;this.act(k.getAttribute("bx-act"),a)},this),m=BX.delegate(function(){this.act("reply",a)},this),n=BX.delegate(function(){this.act("quote",a)},this);if(!!c&&c.length>0){for(var e=0;e<c.length;e++){if(c[e].getAttribute("bx-act")=="moderate"||c[e].getAttribute("bx-act")=="del"){BX.adjust(c[e],{events:{click:d},attrs:{"bx-href":c[e].getAttribute("href"),href:"javascript:void(0);"}})}else{if(!!this.form){if(c[e].getAttribute("bx-act")=="reply"){BX.bind(c[e],"click",m)}else{if(c[e].getAttribute("bx-act")=="quote"){BX.bind(c[e],"mousedown",n)}}}}}}}},act:function(s,v){if(!v||!this.mess["m"+v]){BX.DoNothing()}else{if(s=="quote"){var c=i.GetSelection();if(document.getSelection){c=c.replace(/\r\n\r\n/gi,"_newstringhere_").replace(/\r\n/gi," ");c=c.replace(/  /gi,"").replace(/_newstringhere_/gi,"\r\n\r\n")}if(c===""&&v>0&&BX("message_text_"+v,true)){var a=BX("message_text_"+v,true);if(typeof(a)=="object"&&a){c=a.innerHTML}}c=c.replace(/[\n|\r]*<br(\s)*(\/)*>/gi,"\n");var w=function(k,l){var p=" ";var n=/showWMVPlayer.*?bx_wmv_player.*?file:[\s'"]*([^"']*).*?width:[\s'"]*([^"']*).*?height:[\s'"]*([^'"]*).*?/gi;var m=n.exec(l);if(m){p="[VIDEO WIDTH="+m[2]+" HEIGHT="+m[3]+"]"+m[1]+"[/VIDEO]"}if(p==" "){var o=/bxPlayerOnload[\s\S]*?[\s'"]*file[\s'"]*:[\s'"]*([^"']*)[\s\S]*?[\s'"]*height[\s'"]*:[\s'"]*([^"']*)[\s\S]*?[\s'"]*width[\s'"]*:[\s'"]*([^"']*)/gi;m=o.exec(l);if(m){p="[VIDEO WIDTH="+m[3]+" HEIGHT="+m[2]+"]"+m[1]+"[/VIDEO]"}}return p};c=c.replace(/<script[^>]*>/gi,"\001").replace(/<\/script[^>]*>/gi,"\002");c=c.replace(/\001([^\002]*)\002/gi,w);c=c.replace(/<noscript[^>]*>/gi,"\003").replace(/<\/noscript[^>]*>/gi,"\004");c=c.replace(/\003([^\004]*)\004/gi," ");c=c.replace(/<table class\=[\"]*forum-quote[\"]*>[^<]*<thead>[^<]*<tr>[^<]*<th>([^<]+)<\/th><\/tr><\/thead>[^<]*<tbody>[^<]*<tr>[^<]*<td>/gi,"\001");c=c.replace(/<table class\=[\"]*forum-code[\"]*>[^<]*<thead>[^<]*<tr>[^<]*<th>([^<]+)<\/th><\/tr><\/thead>[^<]*<tbody>[^<]*<tr>[^<]*<td>/gi,"\002");c=c.replace(/<table class\=[\"]*data-table[\"]*>[^<]*<tbody>/gi,"\004");c=c.replace(/<\/td>[^<]*<\/tr>(<\/tbody>)*<\/table>/gi,"\003");c=c.replace(/[\r|\n]{2,}([\001|\002])/gi,"\n$1");var b=0;while(b++<50&&(c.search(/\002([^\002\003]*)\003/gi)>=0||c.search(/\001([^\001\003]*)\003/gi)>=0)){c=c.replace(/\002([^\002\003]*)\003/gi,"[CODE]$1[/CODE]").replace(/\001([^\001\003]*)\003/gi,"[QUOTE]$1[/QUOTE]")}var u=function(l,p,m){var k=new RegExp("\004([^\004\003]*)("+p+")([^\004\003]*)\003","i");var n=new RegExp("((?:\004)(?:[^\004\003]*))("+p+")((?:[^\004\003]*)(?:\003))","i");var o=0;while((o++<300)&&(l.search(k)>=0)){l=l.replace(n,"$1"+m+"$3")}return l};b=0;while(b++<10&&(c.search(/\004([^\004\003]*)\003/gi)>=0)){c=u(c,"<tr>","[TR]");c=u(c,"</tr>","[/TR]");c=u(c,"<td>","[TD]");c=u(c,"</td>","[/TD]");c=c.replace(/\004([^\004\003]*)\003/gi,"[TABLE]$1[/TD][/TR][/TABLE]")}if(BX.browser.IsIE()){c=c.replace(/<img(?:(?:\s+alt\s*=\s*\"?smile([^\"\s]+)\"?)|(?:\s+\w+\s*=\s*[^\s>]*))*>/gi,"$1")}else{c=c.replace(/<img.*?alt=[\"]*smile([^\"\s]+)[\"]*[^>]*>/gi,"$1")}c=c.replace(/<a[^>]+href=[\"]([^\"]+)\"[^>]+>([^<]+)<\/a>/gi,"[URL=$1]$2[/URL]");c=c.replace(/<a[^>]+href=[\']([^\']+)\'[^>]+>([^<]+)<\/a>/gi,"[URL=$1]$2[/URL]");c=c.replace(/<[^>]+>/gi," ").replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&quot;/gi,'"');c=c.replace(/(smile(?=[:;8]))/g,"");c=c.replace(/\&shy;/gi,"");c=c.replace(/\&nbsp;/gi," ");BX.onCustomEvent(this.form,"onQuote",[{author:this.mess["m"+v]["author"],id:v,text:c}])}else{if(s=="reply"){BX.onCustomEvent(this.form,"onReply",[{author:this.mess["m"+v]["author"],id:v}])}else{if(s=="del"&&(!confirm(BX.message("f_cdm")))){BX.DoNothing()}else{if(s=="moderate"||s=="del"){var e=BX.proxy_context,x=e.getAttribute("bx-href").replace(/.AJAX_CALL=Y/g,"").replace(/.sessid=[^&]*/g,""),t=BX.findParent(e,{tag:"table"}),r=BX.create("a",{attrs:{className:"reply-action-note"}}),d=function(){BX.remove(r);BX.show(e.parentNode)};BX.hide(e.parentNode);r.innerHTML=BX.message("f_wait");e.parentNode.parentNode.appendChild(r);BX.ajax.loadJSON(x,{AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},BX.delegate(function(n){if(n.status&&!!t){BX.onCustomEvent(i,"onForumCommentAJAXAction",[s]);if(s=="del"){var k=i.curpage||top.window.location.href;BX.fx.hide(t,"scroll",{time:0.15,callback_complete:BX.delegate(function(){BX.remove(t);d();var p=BX.findChild(BX(this.form.id+"container"),{"class":"reviews-post-table"},true,true);if((!p)||(p.length<1)){if(this.params.pageNumber>1){BX.reload(k)}}},this)})}else{var l=BX.hasClass(t,"reviews-post-hidden");var o=(l?BX.message("f_hide"):BX.message("f_show"));var m=BX.findChild(t,{className:"reviews-text"},true);BX.fx.hide(m,"fade",{time:0.1,callback_complete:function(){BX.toggleClass(t,"reviews-post-hidden");e.innerHTML=o;x=x.replace(new RegExp("REVIEW_ACTION="+(l?"SHOW":"HIDE")),("REVIEW_ACTION="+(l?"HIDE":"SHOW")));e.setAttribute("bx-href",x);BX.fx.show(m,"fade",{time:0.1});d();BX.style(m,"background-color",(l?"#FFFFFF":"#E5F8E3"))}})}}else{BX.addClass(r,"error");r.innerHTML='<span class="errortext">'+n.message+"</span>"}},this))}}}}}return false}};var j=(function(){var a=function(b,c){this.id="FTRForm"+b.form.id;this.form=b.form;this.editor=c;this.windowEvents={};this.params={messageMax:64000};this.onsuccess=BX.delegate(this.onsuccess,this);this.onfailure=BX.delegate(this.onfailure,this);this.submit=BX.delegate(this.submit,this);BX.bind(this.form,"submit",this.submit);this.isAjax=(b.ajaxPost=="Y");if(b.captcha=="Y"){var d=new Captcha(this.form);BX.addCustomEvent(c,"OnContentChanged",BX.proxy(d.Show,d));BX.ready(function(){BX.bind(BX("forum-refresh-captcha"),"click",BX.proxy(d.Update,d))});if(b.bVarsFromForm=="Y"){d.Show()}}BX.addCustomEvent(this.form,"onQuote",BX.delegate(function(e){this.show();this.quote(e)},this));BX.addCustomEvent(this.form,"onReply",BX.delegate(function(e){this.show();this.paste(e)},this));BX.addCustomEvent(this.form,"onTransverse",BX.delegate(this.transverse,this))};a.prototype={submit:function(b){if(this.validate()){this.prepareForm();this.disableButtons(true);if(!this.isAjax){return true}this.send()}return BX.PreventDefault(b)},prepareForm:function(){},disableButtons:function(b){var d=this.form.getElementsByTagName("input");for(var c=0;c<d.length;c++){if(d[c].getAttribute("type")=="submit"){d[c].disabled=(b!==false)}}},validate:function(){this.editor.SaveContent();var b="",d=this.editor.GetContent(),e=d.length,c=64000;if(this.form.TITLE&&(this.form.TITLE.value.length<=0)){b+=BX.message("no_topic_name")}if(e<=0){b+=BX.message("no_message")}else{if(e>c){b+=BX.message("max_len").replace(/#MAX_LENGTH#/gi,c).replace(/#LENGTH#/gi,e)}}if(b!==""){alert(b);return false}return true},busy:false,send:function(){if(this.busy===true){return false}this.busy=true;if(!this.form.elements.dataType){this.form.appendChild(BX.create("input",{props:{type:"hidden",name:"dataType",value:"json"}}))}BX.onCustomEvent(this.form,"onRequest",[this.form,this]);BX.ajax.submitAjax(this.form,{method:"POST",url:this.form.action,dataType:"json",onsuccess:this.onsuccess,onfailure:this.onfailure});return true},onsuccess:function(b){this.busy=false;this.disableButtons(false);BX.onCustomEvent(this.form,"onResponse",[this.form,this]);this.get(b)},onfailure:function(){BX.onCustomEvent(this.form,"onResponse",[this.form,this]);BX.reload()},get:function(l){i.curpage=i.curpage||top.window.location.href;BX.onCustomEvent(i,"onForumCommentAJAXPost",[l,this.form]);if(typeof l=="undefined"||l.reload){BX.reload(i.curpage);return}if(l.status){if(!!l.allMessages||typeof l.message!="undefined"){BX.onCustomEvent(this.form,"onAdd",[l.messageID,l]);this.clear()}else{if(!!l.previewMessage){var b=BX.findChild(document,{className:"reviews-preview"},true),d=BX.findChild(document,{className:/reviews-reply-form|reviews-collapse/},true).parentNode,e=i.fTextToNode(l.previewMessage);i.fReplaceOrInsertNode(e,b,d,{className:/reviews-reply-form|reviews-collapse/});i.PostFormAjaxStatus("");i.fRunScripts(l.previewMessage)}}var c=(!!l.messageID?BX("message"+l.messageID):null);if(c){BX.scrollToNode(c)}}if(l.statusMessage){i.PostFormAjaxStatus(l.statusMessage)}},clear:function(){this.editor.CheckAndReInit("");if(this.editor.fAutosave){BX.bind(this.editor.pEditorDocument,"keydown",BX.proxy(this.editor.fAutosave.Init,this.editor.fAutosave))}var x=BX.findChild(document,{className:"reviews-preview"},true);if(x){BX.remove(x)}var d=0,e,s,c;while((e=BX("upload_files_"+(d++)+"_"+this.form.index.value))&&e){if((s=BX.findChild(e,{tagName:"input"},true))&&BX(s)){c=BX.clone(s);c.value="";s.parentNode.insertBefore(c,s);s.parentNode.removeChild(s)}BX.hide(e)}var t=BX.findChild(this.form,{className:"forum-upload-file-attach"},true);if(t){BX.show(t)}var u=BX.findChild(this.form,{className:"reviews-upload-info"},true);if(u){BX.hide(u)}var b=null,w=BX.findChild(this.form,{attr:{name:"captcha_code"}},true),v=BX.findChild(this.form,{attr:{name:"captcha_word"}},true),y=BX.findChild(this.form,{className:"reviews-reply-field-captcha-image"},true);if(y){b=BX.findChild(y,{tag:"img"})}if(w&&v&&b){v.value="";BX.ajax.getCaptcha(function(k){w.value=k.captcha_sid;b.src="/bitrix/tools/captcha.php?captcha_code="+k.captcha_sid})}},show:function(){BX.onCustomEvent(this.form,"onBeforeShow",[this]);BX.show(this.form.parentNode);BX.scrollToNode(BX.findChild(this.form,{attribute:{name:"send_button"}},true));setTimeout(BX.delegate(function(){this.editor.Focus();BX.defer(this.editor.Focus,this.editor)()},this),100);BX.onCustomEvent(this.form,"onAfterShow",[this]);return false},hide:function(){BX.onCustomEvent(this.form,"onBeforeHide",[this]);BX.hide(this.form.parentNode);BX.onCustomEvent(this.form,"onAfterHide",[this]);return false},transverse:function(){if(this.form.parentNode.style.display=="none"){this.show()}else{this.hide()}return false},quote:function(b){BX.onCustomEvent(this.form,"onPaste",[b,"QUOTE",this]);var d=(b.author||null),c=(b.text||""),e=c;if(this.editor.GetViewMode()=="wysiwyg"){e=e.replace(/\n/g,"<br/>");if(d){if(d.id>0){d='<span id="'+this.editor.SetBxTag(false,{tag:"postuser",params:{value:d.id}})+'" class="bxhtmled-metion">'+d.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>"}else{d="<span>"+d.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>"}d=(d!==""?(d+BX.message("f_author")+"<br/>"):"");e=d+e}}else{if(this.editor.bbCode&&d){if(d.id>0){d="[USER="+d.id+"]"+d.name+"[/USER]"}else{d=d.name}d=(d!==""?(d+BX.message("f_author")+"\n"):"");e=d+e}}this.editor.action.actions.quote.setExternalSelection(e);this.editor.action.Exec("quote")},paste:function(b){BX.onCustomEvent(this.form,"onPaste",[b,"REPLY",this]);var d=(b.author||null);if(d){if(this.editor.GetViewMode()=="wysiwyg"){var c=this.editor.GetIframeDoc(),o=this.editor.selection.GetRange(),n=BX.create("SPAN",{props:{className:"bxhtmled-metion"},text:BX.util.htmlspecialcharsback(d.name)},c),e=BX.create("SPAN",{html:",&nbsp;"},c);this.editor.SetBxTag(n,{tag:"postuser",params:{value:d.id}});this.editor.selection.InsertNode(n,o);if(n&&n.parentNode){var p=BX.findParent(n,{className:"bxhtmled-metion"},c.body);if(p){this.editor.util.InsertAfter(n,p)}}if(n&&n.parentNode){this.editor.util.InsertAfter(e,n);this.editor.selection.SetAfter(e)}}else{if(this.editor.GetViewMode()=="code"&&this.editor.bbCode){this.editor.textareaView.Focus();this.editor.textareaView.WrapWith(false,false,"[USER="+d.id+"]"+d.name+"[/USER],")}}}}};return a})(),f=[];BX.Forum.Init=function(a){if(!a||typeof a!="object"){return}new h(a);var c,b;while((c=f.pop())&&c){BX.removeCustomEvent(i,"OnEditorInitedAfter",c)}b=function(d){g(d,a);BX.removeCustomEvent(i,"OnEditorInitedAfter",b)};f.push(b);BX.addCustomEvent(i,"OnEditorInitedAfter",b)};var g=function(b,a){if(b.id==a.lheId){b.insertImageAfterUpload=true;BX.bind(BX("post_message_hidden"),"focus",function(){b.Focus()});new j(a,b)}};BX.ready(function(){if(BX.browser.IsIE()){var a=BX.findChildren(document,{className:"reviews-post-table"},true),b,c,d;if(!a){return}for(b=0;b<a.length;b++){c=a[b].getElementsByTagName("*");d=c.length;while(d--){if(c[d].scrollWidth>c[d].offsetWidth){c[d].style.paddingBottom="20px";c[d].style.overflowY="hidden"}}}}});i.fTextToNode=function(a){var b=BX.create("div");b.innerHTML=a;if(b.childNodes.length>0){return b}else{return null}};i.PostFormAjaxStatus=function(o){var q=BX.findChild(document,{className:"reviews-note-box"},true,true),c;if(q){for(c=0;c<=q.length;c++){BX.remove(q[c])}}var p=BX.findChild(document,{className:"reviews-block-container"},true);if(!p){return}if(o.length<1){return}var a=i.fTextToNode(o);if(!a){return}var e=["reviews-reply-form","reviews-collapse"];var d=p;while((d=d.nextSibling)&&!!d){if(d.nodeType==1){var b=false;for(c=0;c<e.length;c++){if(BX.hasClass(d,e[c])){b=true;break}}if(b){d.parentNode.insertBefore(a,d);break}}}};i.SetReviewsAjaxPostTmp=function(a){i.forumAjaxPostTmp=a};i.fReplaceOrInsertNode=function(d,b,c,a){var e=null;if(!BX.type.isDomNode(c)){return false}if(!BX.type.isDomNode(d)&&!BX.type.isArray(d)&&d.length>0){if(!(d=i.fTextToNode(d))){return false}}if(BX.type.isDomNode(b)){c=b.parentNode;e=b.nextSibling;c.removeChild(b)}if(!e){e=BX.findChild(c,a,true)}if(e){e.parentNode.insertBefore(d,e)}else{c.appendChild(d)}return true};i.fRunScripts=function(a){var b=BX.processHTML(a,true);BX.ajax.processScripts(b.SCRIPT,true)};i.ShowLastEditReason=function(b,a){if(a){if(b){a.style.display="block"}else{a.style.display="none"}}};i.AttachFile=function(e,a,b,o){var n=null;var p=false;e=parseInt(e);a=parseInt(a);document.getElementById("upload_files_info_"+b).style.display="block";for(var d=e;d<(e+a);d++){n=document.getElementById("upload_files_"+d+"_"+b);if(!n||typeof(n)===null){break}if(n.style.display=="none"){p=true;n.style.display="block";break}}var c=(!p?true:(d>=(e+a-1)));if(c===true){o.style.display="none"}};i.GetSelection=function(){var b,a="";if(i.getSelection){b=i.getSelection();a=b.toString()}else{if(document.selection){b=document.selection;a=b.createRange().text}}return a}})(window);
(function(b){if(b.JCIblockVoteStars){return}b.JCIblockVoteStars=function(a){this.progressObj=null;this.ratingObj=null;this.starsObj=null;this.progressId="";this.ratingId="";this.starsId="";this.ajaxParams={};this.siteId="";this.voteData={element:0,percent:0,count:0};this.config={readOnly:false,alreadyVoted:true,request:false};if(BX.type.isPlainObject(a)){if(BX.type.isNotEmptyString(a.progressId)){this.progressId=a.progressId}if(BX.type.isNotEmptyString(a.ratingId)){this.ratingId=a.ratingId}if(BX.type.isNotEmptyString(a.starsId)){this.starsId=a.starsId}if(BX.type.isNotEmptyString(a.ajaxUrl)){this.ajaxUrl=a.ajaxUrl}if(BX.type.isNotEmptyString(a.checkVoteUrl)){this.checkVoteUrl=a.checkVoteUrl}if(BX.type.isPlainObject(a.ajaxParams)){this.ajaxParams=a.ajaxParams}if(BX.type.isNotEmptyString(a.siteId)){this.siteId=a.siteId}if(BX.type.isPlainObject(a.voteData)){if(BX.type.isNumber(a.voteData.element)){this.voteData.element=a.voteData.element}if(BX.type.isNumber(a.voteData.percent)){this.voteData.percent=this.preparePercent(a.voteData.percent)}if(BX.type.isNumber(a.voteData.count)){this.voteData.count=a.voteData.count}}if(BX.type.isBoolean(a.readOnly)){this.config.readOnly=a.readOnly}}BX.ready(BX.proxy(this.init,this))};b.JCIblockVoteStars.prototype.init=function(){if(BX.type.isNotEmptyString(this.progressId)){this.progressObj=BX(this.progressId)}if(BX.type.isNotEmptyString(this.ratingId)){this.ratingObj=BX(this.ratingId)}if(BX.type.isNotEmptyString(this.starsId)){this.starsObj=BX(this.starsId)}this.showProgress(this.voteData.percent);this.showVotes();this.checkVote()};b.JCIblockVoteStars.prototype.checkVote=function(){if(this.config.readOnly||this.voteData.element<=0){return}BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.checkVoteUrl,data:{sessid:BX.bitrix_sessid(),checkVote:"Y",vote_id:this.voteData.element,site_id:this.siteId},onsuccess:BX.proxy(this.checkVoteResult,this)})};b.JCIblockVoteStars.prototype.checkVoteResult=function(a){if(BX.type.isPlainObject(a)){if(a.success){this.config.alreadyVoted=a.voted}}if(this.config.readOnly||this.config.alreadyVoted||this.voteData.element<=0){return}if(BX.type.isElementNode(this.starsObj)){BX.bind(this.starsObj,"mousemove",BX.proxy(this.handlerMouseMove,this));BX.bind(this.starsObj,"mouseout",BX.proxy(this.handlerMouseOut,this));BX.bind(this.starsObj,"click",BX.proxy(this.handlerClick,this))}};b.JCIblockVoteStars.prototype.destroy=function(){if(BX.type.isElementNode(this.progressObj)){BX.unbindAll(this.progressObj)}this.progressObj=null;if(BX.type.isElementNode(this.ratingObj)){BX.unbindAll(this.ratingObj)}this.ratingObj=null;if(BX.type.isElementNode(this.starsObj)){BX.unbindAll(this.starsObj)}this.starsObj=null};b.JCIblockVoteStars.prototype.preparePercent=function(a){a=parseInt(a,10);if(isNaN(a)){a=0}else{if(a>100){a=100}else{if(a<0){a=0}}}return a};b.JCIblockVoteStars.prototype.showProgress=function(a){if(!BX.type.isElementNode(this.progressObj)){return}BX.style(this.progressObj,"width",a.toString()+"%")};b.JCIblockVoteStars.prototype.showVotes=function(){if(!BX.type.isElementNode(this.ratingObj)){return}this.ratingObj.innerHTML="( "+this.voteData.count+" )"};b.JCIblockVoteStars.prototype.handlerMouseMove=function(e){var f,a;if(this.config.readOnly||this.config.alreadyVoted||this.config.request){return}e=e||b.event;if(!BX.type.isElementNode(this.starsObj)){return}f=BX.pos(this.starsObj);a=((e.pageX-f.left)/f.width)*5;this.showProgress(this.preparePercent(Math.ceil(a)*20))};b.JCIblockVoteStars.prototype.handlerMouseOut=function(){if(this.config.readOnly||this.config.alreadyVoted||this.config.request){return}this.showProgress(this.voteData.percent)};b.JCIblockVoteStars.prototype.handlerClick=function(e){var a,f;if(this.config.readOnly||this.config.alreadyVoted||this.config.request){return}this.config.request=true;e=e||b.event;if(!BX.type.isElementNode(this.starsObj)){return}a=BX.pos(this.starsObj);f=parseInt(Math.ceil(((e.pageX-a.left)/a.width)*5),10);if(isNaN(f)){return}this.ajaxParams.rating=f-1;this.ajaxParams.vote="Y";this.ajaxParams.vote_id=this.voteData.element;this.ajaxParams.sessid=BX.bitrix_sessid();this.ajaxParams.site_id=this.siteId;BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:this.ajaxParams,onsuccess:BX.proxy(this.clickResult,this)})};b.JCIblockVoteStars.prototype.clickResult=function(a){this.config.request=false;if(BX.type.isPlainObject(a)){this.config.alreadyVoted=true;this.voteData.percent=this.preparePercent((a.value)*20);this.voteData.count=a.votes;this.showProgress(this.voteData.percent);this.showVotes()}}})(window);